version: '3.8'

# ============================================
# Development Environment Configuration
# ============================================
#
# IMPORTANT: This project uses Doppler for secrets management
#
# Doppler Configuration:
#   - Project: integrity-studio
#   - Environment: dev
#   - Config: dev
#
# Setup Doppler:
#   1. Install: brew install dopplerhq/cli/doppler
#   2. Login: doppler login
#   3. Setup: doppler setup --project integrity-studio --config dev
#
# Usage with Doppler (RECOMMENDED):
#   doppler run -- docker-compose -f config/docker-compose.base.yml -f config/docker-compose.dev.yml up -d
#
# Usage without Doppler (requires .env file):
#   docker-compose -f config/docker-compose.base.yml -f config/docker-compose.dev.yml up -d
#
# Extends config/docker-compose.base.yml with development-specific overrides
# ============================================

services:
  # ============================================
  # PostgreSQL - Development
  # ============================================
  postgres:
    environment:
      # Use simpler credentials in development
      - POSTGRES_PASSWORD=postgres
    volumes:
      # Expose initialization scripts for development
      - ./server/prisma/migrations:/docker-entrypoint-initdb.d
    ports:
      # Expose on standard port for local access (uses POSTGRES_PORT from .env)
      - "${POSTGRES_PORT:-5432}:5432"

  # ============================================
  # Redis - Development
  # ============================================
  redis:
    ports:
      # Uses REDIS_PORT from .env
      - "${REDIS_PORT:-6379}:6379"
    # Use less restrictive memory settings in dev
    command: redis-server --appendonly yes

  # ============================================
  # Backend - Development with Hot Reload
  # ============================================
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: development  # Use development stage
    container_name: tcad-backend-dev
    environment:
      - NODE_ENV=development
      - LOG_LEVEL=debug
      # Enable verbose Prisma logging
      - DEBUG=prisma:*
    volumes:
      # Mount source code for hot reload
      - ./server/src:/app/src:ro
      - ./server/prisma:/app/prisma:ro
      - ./server/package.json:/app/package.json:ro
      - ./server/tsconfig.json:/app/tsconfig.json:ro
      # Preserve node_modules from container
      - /app/node_modules
      # Mount results directory
      - ./results:/app/results
    ports:
      # Uses BACKEND_PORT and BACKEND_DEBUG_PORT from .env
      - "${BACKEND_PORT:-3000}:3000"
      # Expose debugger port
      - "${BACKEND_DEBUG_PORT:-9229}:9229"
    command: npx tsx watch --inspect=0.0.0.0:9229 src/index.ts

  # ============================================
  # Frontend - Development with Vite HMR
  # ============================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: development  # Use development stage
    container_name: tcad-frontend-dev
    environment:
      - NODE_ENV=development
      # Vite specific
      - VITE_API_URL=http://localhost:3000
      # Frontend port configuration (reads from .env or defaults to 3002)
      - FRONTEND_PORT=${FRONTEND_PORT:-3002}
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src:ro
      - ./public:/app/public:ro
      - ./index.html:/app/index.html:ro
      - ./vite.config.ts:/app/vite.config.ts:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./package.json:/app/package.json:ro
      # Preserve node_modules from container
      - /app/node_modules
    ports:
      # Map host port to container port (uses FRONTEND_PORT from .env)
      - "${FRONTEND_PORT:-5174}:${FRONTEND_PORT:-5174}"
    command: npm run dev -- --host 0.0.0.0

  # ============================================
  # BullMQ Metrics - Development
  # ============================================
  bullmq-metrics:
    container_name: tcad-bullmq-metrics-dev
    ports:
      # Uses BULLMQ_METRICS_PORT from .env
      - "${BULLMQ_METRICS_PORT:-4000}:3000"

  # ============================================
  # Prometheus - Development (Optional)
  # ============================================
  prometheus:
    image: prom/prometheus:latest
    container_name: tcad-prometheus-dev
    networks:
      - tcad-network
    volumes:
      - ./config/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/monitoring/prometheus/prometheus.rules.yml:/etc/prometheus/prometheus.rules.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      # Uses PROMETHEUS_PORT from .env
      - "${PROMETHEUS_PORT:-9090}:9090"
    restart: unless-stopped
    depends_on:
      - bullmq-metrics

  # ============================================
  # Grafana - Development (Optional)
  # ============================================
  grafana:
    image: grafana/grafana:latest
    container_name: tcad-grafana-dev
    networks:
      - tcad-network
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./config/monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
    ports:
      # Uses GRAFANA_PORT from .env
      - "${GRAFANA_PORT:-3001}:3000"
    restart: unless-stopped
    depends_on:
      - prometheus

networks:
  tcad-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  prometheus-data:
  grafana-data:
